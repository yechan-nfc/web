<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" />
    <title>숨 녹음 페이지</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <style type="text/css">
        @font-face {
            font-family: 'BM HANNA 11yrs old';
            src: url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNA11yrsold.eot);
            src: url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNA11yrsold.eot?#iefix) format('embedded-opentype'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNA11yrsold.woff2) format('woff2'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNA11yrsold.woff) format('woff'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNA_11yrs_ttf.ttf) format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'BM HANNA Air';
            src: url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNAAir.eot);
            src: url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNAAir.eot?#iefix) format('embedded-opentype'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNAAir.woff2) format('woff2'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNAAir.woff) format('woff'),
                 url(//cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FBMHANNAAir.ttf) format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
    
        html,
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
    
        #wrap {
            position: relative;
            max-width: 420px;
            min-width: 300px;
            max-height: 850px;
            min-height: 550px;
            width: 100%;
            height: 100%;
            background: rgba(108, 192, 186, 1);
        }

        #help {
			position:absolute;
    		border:double;
			width:84%; 
			height:80%;
			margin:5%;
            z-index:1; 
            opacity: 0.9;
			visibility:hidden;
			background-color:white;
            padding: 3%;
            text-align: left;
		    font-family: 'BM HANNA Air';
		    font-style: normal;
		    font-weight: normal;
            font-size: 15px;
            border-radius: 12px;
        }
        
        #help img{
            margin: 2%;
            width: 15%;
            float: right;
        }

        #recordingList {
            position:absolute;
            overflow: scroll;
            top: 2%;
    		border:double;
			width:84%; 
			height:80%;
			margin:5%;
            z-index:1; 
            opacity: 0.9;
			visibility:hidden;
			background-color:white;
            padding: 3%;
            text-align: left;
		    font-family: 'BM HANNA Air';
		    font-style: normal;
		    font-weight: normal;
            font-size: 15px;
            border-radius: 12px;
        }

        #content {
            width: 100%;
            height: 90%;
            text-align: center;
        }

        #startRecordingButton {
            height: 45%;
            width: 70%;
            padding: 0%;
            border: none;
        }

        #startRecordingButton img {
            margin: 0%;
            width: 100%;
            height: 100%;
        }

        #recordingImg {
            height: 15%;
            text-align: center;
            visibility: hidden;
        }

        #recordingImg img {
            margin-top: 15%;
            width: 30%;
            opacity: 0.5;
        }

        #recordingCondition {
            height: 10%;
            vertical-align: middle;
		    font-family: 'BM HANNA 11yrs old';
		    font-size: 18px;
		    color: rgba(101,99,99,1);
        }

        #recordButtonArea {
            height: 30%;
            visibility: hidden;
        }

        #resumeButton{
            position: absolute;
            left: 20%;
            margin: 5% 8% 5% 8%;
            height: 7%;
            width: 14%;
            padding: 0%;
            border: none;
            visibility: hidden;
        }
        #pauseButton{
            position: absolute;
            left: 20%;
            margin: 5% 8% 5% 8%;
            height: 7%;
            width: 14%;
            padding: 0%;
            border: none;
            visibility: hidden;
        }
        #recordButtonArea button {
            position: absolute;
            right: 20%;
            margin: 5% 8% 5% 8%;
            height: 7%;
            width: 14%;
            padding: 0%;
            border: none;
        }

        #recordButtonArea img {
            margin: 0%;
            width: 100%;
            height: 100%;
        }

        #buttonArea {
            width: 100%;
            height: 10%;
        }

        #buttonArea img {
            height: 60%;
            margin-left: 7%;
            margin-right: 7%;
        }

        #openRecordingListButton {
            position: absolute;
            visibility: hidden;
            float: center;
            width: 25%;
            height: 6%;
            left: 40%;
            opacity: 0.8;
		    fill: rgba(255,255,255,1);
		    stroke: rgba(112,112,112,0.98);
		    stroke-width: 4px;
		    stroke-linejoin: miter;
		    stroke-linecap: butt;
		    stroke-miterlimit: 4;
		    shape-rendering: auto;
            text-align: center;
            font-family: 'BM HANNA 11yrs old';
            font-size: 15px;
		    color: rgba(0,0,0,1);
            border-radius: 12px;
        }

        #closeRecordingListButton {
            position: absolute;
            visibility: hidden;
            float: center;
            width: 25%;
            height: 6%;
            left: 40%;
            opacity: 0.8;
		    fill: rgba(255,255,255,1);
		    stroke: rgba(112,112,112,0.98);
		    stroke-width: 4px;
		    stroke-linejoin: miter;
		    stroke-linecap: butt;
		    stroke-miterlimit: 4;
		    shape-rendering: auto;
            text-align: center;
            font-family: 'BM HANNA 11yrs old';
            font-size: 15px;
		    color: rgba(0,0,0,1);
            border-radius: 12px;
        }

        #openHelpButton {
            position: absolute;
            visibility: visible;
            float: right;
            width: 25%;
            height: 6%;
            right: 7%;
            opacity: 0.8;
		    fill: rgba(255,255,255,1);
		    stroke: rgba(112,112,112,0.98);
		    stroke-width: 4px;
		    stroke-linejoin: miter;
		    stroke-linecap: butt;
		    stroke-miterlimit: 4;
		    shape-rendering: auto;
            text-align: center;
            font-family: 'BM HANNA 11yrs old';
            font-size: 15px;
		    color: rgba(0,0,0,1);
            border-radius: 12px;
        }

        #closeHelpButton {
            position: absolute;
            visibility: hidden;
            float: right;
            width: 25%;
            height: 6%;
            right: 7%;
            opacity: 0.8;
		    fill: rgba(255,255,255,1);
		    stroke: rgba(112,112,112,0.98);
		    stroke-width: 4px;
		    stroke-linejoin: miter;
		    stroke-linecap: butt;
		    stroke-miterlimit: 4;
		    shape-rendering: auto;
            text-align: center;
            font-family: 'BM HANNA 11yrs old';
            font-size: 15px;
		    color: rgba(0,0,0,1);
            border-radius: 12px;
        }

        .clip p {
            margin-top: 2%;
            display: inline-block;
            font-family: 'BM HANNA Air';
            font-size: 1rem;
        }

        .clip button {
            margin-right: 1%;
            font-size: 1rem;
            float: right;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div id="wrap">
        <div id="help">
			<a href="https://open.kakao.com/o/sbxoaoOc" target="_blank"><img src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FKakaotalk_icon.jpg?v=1610126420090" alt="카카오톡 아이콘"></a>
			<p>아래에 적힌 내용 이외의 질문이 있으시면
            <br>카카오톡 1:1 문의로 연락 주세요 :)
            <br><br><br>Q1. 녹음은 어떻게 시작하나요?
            <br><br>A1. 주변 환경을 정리하신 후, 마이크 위에 있는 빨간색 버튼을 눌러주시면 녹음이 시작됩니다 :)
            <br><br><br>Q2. 녹음을 하다가 마음에 안 들면 어떻게 하나요?
            <br><br>A2. 녹음 정지 버튼을 누르신 후, 처음부터 다시 녹음하시면 됩니다 :)
            <br><br><br>Q3. 녹음 중간에 잡음이 들렸어요. 처음부터 다시 녹음하고 싶지는 않은데 어떻게 하면 되나요?
            <br><br>A3. (개발팀이랑 얘기해보고 추가)
            </p>
		</div>
        <div id="content">
            <div id="recordingImg">
                <img class="animationImg" class="animate__animated animate__heartBeat animate__infinite"
                    src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2Fdot.png?v=1611228671755" alt="녹음 중 이미지">
            </div>
            <div id="recordingCondition">
                <p id="recordingConditionWord">준비되시면 
                <br>녹음 시작 버튼을 눌러주세요 :)</p>
            </div>
            <button class="record" id="startRecordingButton"><img id="micImg" src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FmicRecordingBefore.jpg?v=1611219755470" alt="녹음기 시작 이미지"></button>
            <div id="recordButtonArea">
                <button class="resume" id="resumeButton"><img id="startIcon" src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FplayIcon.jpg?v=1611217982043" alt="시작 아이콘"></button>
                <button class="pause" id="pauseButton"><img id="pauseIcon" src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FpauseIcon.jpg?v=1611217981799" alt="일시정지 아이콘"></button>
                <button class="stop" id="stopButton"><img id="stopIcon" src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FstopIcon.jpg?v=1611217985899" alt="정지 아이콘"></button>
            </div>
            <div id="recordingList">
                <section class="sound-clips">
				</section>
            </div>
            <script>
                var element = document.getElementById("recordingConditionWord");
                const animationElement = document.querySelector('.animationImg');
                const record = document.querySelector('.record');
                const resume = document.querySelector('.resume');
                const pause = document.querySelector('.pause'); 
				const stop = document.querySelector('.stop');
				const soundClips = document.querySelector('.sound-clips');
				var tryRecordNumber = 0;
		
				stop.disabled = true;
				
				let audioCtx;
			
				if (navigator.mediaDevices.getUserMedia) {
					console.log('getUserMedia supported.');
		
					const constraints = { audio: true };
					let chunks = [];
		
					let onSuccess = function (stream) {
						const mediaRecorder = new MediaRecorder(stream);
		
						record.onclick = function () {
							mediaRecorder.start();
							console.log(mediaRecorder.state);
							console.log("recorder started");
							tryRecordNumber = tryRecordNumber + 1;
                            
                            document.all.recordingImg.style.visibility="visible";
                            animationElement.classList.add('animate__animated', 'animate__pulse', 'animate__infinite');
                            document.all.recordingImg.style.opacity="1";
                            element.innerText = "녹음 중 입니다";
                            document.all.micImg.src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FmicRecording.jpg?v=1611231795613";
                            document.all.recordButtonArea.style.visibility="visible";
                            document.all.resumeButton.style.visibility="hidden";
                            document.all.pauseButton.style.visibility="visible";
                            document.all.openRecordingListButton.style.visibility="visible";
                            stop.disabled = false;
							record.disabled = true;
                        }
                        
                        resume.onclick = function () {
							mediaRecorder.resume();
							console.log(mediaRecorder.state);
							console.log("recorder started");
                            
                            animationElement.classList.add('animate__animated', 'animate__pulse', 'animate__infinite');
                            document.all.recordingImg.style.opacity="1";
                            element.innerText = "녹음 중 입니다";
                            document.all.resumeButton.style.visibility="hidden";
                            document.all.pauseButton.style.visibility="visible";
                            stop.disabled = false;
							record.disabled = true;
						}

                        pause.onclick = function () {
							mediaRecorder.pause();
							console.log(mediaRecorder.state);
							console.log("recorder paused");
                            
                            animationElement.classList.remove('animate__animated', 'animate__pulse', 'animate__infinite');
                            document.all.recordingImg.style.opacity="0.4";
                            element.innerText = "녹음이 일시 정지되었습니다";
                            document.all.resumeButton.style.visibility="visible";
                            document.all.pauseButton.style.visibility="hidden";
                            stop.disabled = false;
							record.disabled = true;
						}
		
						stop.onclick = function () {
							mediaRecorder.stop();
							console.log(mediaRecorder.state);
							console.log("recorder stopped");
                            // mediaRecorder.requestData();
                            
                            document.all.recordingImg.style.visibility="hidden";
                            element.innerText = "준비되시면\n녹음 시작 버튼을 눌러주세요 :)";
                            element.innerText.replace(/\n/g, '<br/>');
                            document.all.micImg.src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FmicRecordingBefore.jpg?v=1611219755470";
                            document.all.recordButtonArea.style.visibility="hidden";
                            document.all.resumeButton.style.visibility="hidden";
                            document.all.pauseButton.style.visibility="hidden";
                            document.all.openRecordingListButton.style.visibility="visible";
							stop.disabled = true;
							record.disabled = false;
						}
		
						mediaRecorder.onstop = function (e) {
							console.log("data available after MediaRecorder.stop() called.");
		
							//const clipName = prompt('녹음본 이름을 정해주세요', '나의 녹음본');
		
							const clipContainer = document.createElement('article');
							const clipLabel = document.createElement('p');
                            const audio = document.createElement('audio');
                            const selectButton = document.createElement('button');
							const deleteButton = document.createElement('button');
		
							clipContainer.classList.add('clip');
                            audio.setAttribute('controls', '');
                            selectButton.textContent = '결정';
                            selectButton.className = 'select';
							deleteButton.textContent = '삭제';
							deleteButton.className = 'delete';
                            
							clipLabel.textContent = '나의 녹음본 ' + tryRecordNumber;
                            
							clipContainer.appendChild(audio);
                            clipContainer.appendChild(clipLabel);
                            clipContainer.appendChild(deleteButton);
                            clipContainer.appendChild(selectButton);
							soundClips.appendChild(clipContainer);

							audio.controls = true;
							const blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
							chunks = [];
							const audioURL = window.URL.createObjectURL(blob);
							audio.src = audioURL;
                            console.log("recorder stopped");

                            selectButton.onclick = function (e) {
                                alert('audio URL:'+audioURL+' -> 최종 결정하시겠습니까?');
                                // 파일 선택시 해당 음성파일 전송 기능 넣기
                                console.log("record file selected! -> audio URL: "+audioURL);
							}
		
							deleteButton.onclick = function (e) {
								let evtTgt = e.target;
                                evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
                                console.log("record file deleted");
							}
						}
		
						mediaRecorder.ondataavailable = function (e) {
							chunks.push(e.data);
						}
					}
		
					let onError = function (err) {
						console.log('The following error occured: ' + err);
					}
		
					navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);
		
				} else {
					console.log('getUserMedia not supported on your browser!');
				}
			</script>
        </div>
        <div id="buttonArea">
            <a href="index.html"><img src="https://cdn.glitch.com/e587798e-1d89-4773-8fcc-9fe58f9fb564%2FhomeIcon.jpg?v=1611217978016" alt="홈버튼 아이콘"></a>
            <button id="openRecordingListButton" onClick="openList()" >녹음 목록 보기</button>
            <button id="closeRecordingListButton" onClick="closeList()" >녹음 목록 닫기</button>
            <button id="openHelpButton" onClick="openHelp()">도움말</button>
            <button id="closeHelpButton" onClick="closeHelp()">도움말 닫기</button>
        </div>
    </div>
    <script>
        function openList() {
            document.all.recordingList.style.visibility="visible";
            document.all.openRecordingListButton.style.visibility="hidden";
            document.all.closeRecordingListButton.style.visibility="visible";
		}
		function closeList() {
            document.all.recordingList.style.visibility="hidden";
            document.all.openRecordingListButton.style.visibility="visible";
            document.all.closeRecordingListButton.style.visibility="hidden";
		}
		function openHelp() {
            document.all.help.style.visibility="visible";
            document.all.openHelpButton.style.visibility="hidden";
            document.all.closeHelpButton.style.visibility="visible";
		}
		function closeHelp() {
            document.all.help.style.visibility="hidden";
            document.all.openHelpButton.style.visibility="visible";
            document.all.closeHelpButton.style.visibility="hidden";
		}
	</script>
</body>
</html>
